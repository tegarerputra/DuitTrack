<script lang="ts">
  import { onMount, onDestroy } from 'svelte';
  import { page } from '$app/stores';
  import { goto } from '$app/navigation';
  import { writable, derived } from 'svelte/store';
  import { expenseActions } from '../../lib/stores/expenses';
  import { budgetStore, budgetActions } from '../../lib/stores/budget';
  import { authService } from '../../lib/services/authService';
  import { expenseService } from '../../lib/services/expenseService';
  import { budgetService } from '../../lib/services/budgetService';
  import { periodService } from '../../lib/services/periodService';
  import { DataService } from '../../lib/services/dataService';
  import SmartWarning from '../../lib/components/expense/SmartWarning.svelte';
  import CategoryTileSelector from '../../lib/components/expense/CategoryTileSelector.svelte';

  // Navigation context
  let returnPath = '';
  let dataService: DataService | null = null;
  let isSubmitting = false;
  let showSuccessState = false;
  let dailyWarnings = new Map();
  let categories: any[] = [];
  let isLoadingCategories = false;

  // Helper function to get current date (single source of truth)
  function getCurrentDate(): string {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Local state for form fields - Initialize with current date
  let dateValue: string = getCurrentDate();
  let dateInputKey = 0; // Key to force re-render

  // Form data stores - Initialize with today's date and empty category
  const formData = writable({
    amount: '',
    category: '',  // Empty = no category selected (will be saved as UNCATEGORIZED)
    description: '',
    date: getCurrentDate()
  });

  const errors = writable({
    amount: '',
    category: '',
    description: '',
    date: '',
    system: ''
  });

  const smartWarning = writable({
    show: false,
    type: '',
    data: {}
  });

  // Validation constants
  const MAX_AMOUNT = 999999999;
  const MIN_AMOUNT = 1;

  // Helper function to validate amount
  function isValidAmount(amount: number): boolean {
    return amount >= MIN_AMOUNT && amount <= MAX_AMOUNT;
  }

  // Derived stores
  const isFormValid = derived(
    [formData, errors],
    ([$formData, $errors]) => {
      const amount = parseCurrencyInput($formData.amount);
      return isValidAmount(amount) &&
             $formData.date &&
             !$errors.date &&
             !$errors.amount;
    }
  );

  // Reactive variable for categories check
  $: hasCategories = categories && categories.length > 0 && !categories.every(cat => cat.disabled);

  // Reactive subscription to budget store - automatically update categories when budget changes
  $: {
    if ($budgetStore && typeof $budgetStore === 'object' && $budgetStore.categories) {
      try {
        // Filter out UNCATEGORIZED - only show categories with budget allocation
        categories = Object.entries($budgetStore.categories)
          .filter(([key]) => key.toUpperCase() !== 'UNCATEGORIZED')
          .map(([key, data]: [string, any]) => ({
            value: key.toUpperCase(),
            label: formatCategoryName(key),
            disabled: false,
            budget: data.budget || 0,
            spent: data.spent || 0
          }));
        isLoadingCategories = false;
      } catch (error) {
        console.error('Error processing budget categories:', error);
        categories = [];
        isLoadingCategories = false;
      }
    } else if ($budgetStore === null) {
      // Budget store explicitly set to null (no budget configured)
      categories = [];
      isLoadingCategories = false;
    }
  }

  // Cleanup timeout on destroy
  onDestroy(() => {
    if (validationTimeout) {
      clearTimeout(validationTimeout);
    }
  });

  // Component initialization
  onMount(async () => {
    // Get return path from URL params
    returnPath = $page.url.searchParams.get('return') || 'dashboard';

    // Ensure date is set to today and force re-render
    const currentDate = getCurrentDate();
    dateValue = currentDate;
    formData.update(data => ({ ...data, date: currentDate }));
    dateInputKey++; // Force re-render of date input

    // Explicitly set date input value after a short delay
    setTimeout(() => {
      const dateInput = document.getElementById('expenseDate') as HTMLInputElement;
      if (dateInput && !dateInput.value) {
        dateInput.value = currentDate;
        dateValue = currentDate;
      }
    }, 50);

    await initializeExpenseForm();
    await loadBudgetAndCategories();
  });

  // Watch for form changes to trigger smart validation
  $: {
    try {
      if ($formData && $formData.amount && $formData.category && $formData.category !== 'UNCATEGORIZED') {
        debounceSmartValidation();
      }
    } catch (error) {
      console.error('Error in smart validation watch:', error);
    }
  }

  async function initializeExpenseForm() {
    try {
      const user = await authService.getCurrentUser();
      if (user) {
        dataService = new DataService(user.uid);
      }
    } catch (error) {
      console.error('Error initializing expense form:', error);
    }
  }

  async function loadBudgetAndCategories() {
    try {
      isLoadingCategories = true;

      // 🔥 FIREBASE: Load budget from Firestore
      const currentPeriodId = await periodService.getCurrentPeriodId();
      const budget = await budgetService.getBudgetByPeriod(currentPeriodId);

      if (budget) {
        // Set budget store with Firebase data
        budgetStore.set({
          categories: budget.categories,
          totalBudget: budget.totalBudget,
          totalSpent: budget.totalSpent
        });
        console.log('✅ Budget loaded from Firebase:', budget);
      } else {
        // No budget found - set empty
        budgetStore.set({
          categories: {},
          totalBudget: 0,
          totalSpent: 0
        });
        console.log('ℹ️ No budget found for period, showing empty state');
      }

      // Reactive statement will set isLoadingCategories to false
    } catch (error) {
      console.error('Error loading categories:', error);
      categories = [];
      isLoadingCategories = false;
    }
  }

  function formatCurrencyInput(amount: number): string {
    if (!amount) return '';
    return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  function parseCurrencyInput(formattedValue: string): number {
    return parseInt(formattedValue.replace(/\./g, '') || '0', 10);
  }

  function handleAmountInput(event: Event) {
    const target = event.target as HTMLInputElement;
    const value = target.value;

    // Clean input: remove all non-digits
    const cleanValue = value.replace(/[^\d]/g, '');

    // Format with dots as thousand separators
    const formattedValue = cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    // Update input and store
    target.value = formattedValue;
    formData.update(data => ({ ...data, amount: formattedValue }));

    // Clear previous amount errors
    errors.update(errs => ({ ...errs, amount: '' }));

    // Validate amount using consolidated logic
    const amount = parseCurrencyInput(formattedValue);
    if (amount > MAX_AMOUNT) {
      errors.update(errs => ({ ...errs, amount: `Whoa there, millionaire! Max Rp ${formatCurrencyInput(MAX_AMOUNT)} please!` }));
    }
  }

  function handleCategoryChange(event: Event) {
    const target = event.target as HTMLSelectElement;
    formData.update(data => ({ ...data, category: target.value }));
    errors.update(errs => ({ ...errs, category: '' }));
  }

  function handleCategoryTileChange(event: CustomEvent) {
    const category = event.detail.category;
    // Empty category = UNCATEGORIZED
    const finalCategory = category === '' ? 'UNCATEGORIZED' : category;
    formData.update(data => ({ ...data, category: finalCategory }));
    errors.update(errs => ({ ...errs, category: '' }));
  }

  function handleSetupBudget() {
    goto('/budget');
  }

  function handleDescriptionInput(event: Event) {
    const target = event.target as HTMLInputElement;
    formData.update(data => ({ ...data, description: target.value }));
    errors.update(errs => ({ ...errs, description: '' }));
  }

  function handleDateChange(event: Event) {
    const target = event.target as HTMLInputElement;
    dateValue = target.value;
    formData.update(data => ({ ...data, date: target.value }));
    errors.update(errs => ({ ...errs, date: '' }));

    // Validate date
    if (target.value) {
      validateDateInput(target.value);
    }

    // Clear old warnings when date changes (cleanup memory)
    const today = new Date().toDateString();
    const keysToDelete: string[] = [];

    dailyWarnings.forEach((value, key) => {
      if (value !== today) {
        keysToDelete.push(key);
      }
    });

    keysToDelete.forEach(key => dailyWarnings.delete(key));
  }

  function handleDateClick(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input && input.showPicker) {
      input.showPicker();
    }
  }

  function handleDateFocus(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input && input.showPicker) {
      input.showPicker();
    }
  }

  function validateDateInput(dateValue: string): boolean {
    const date = new Date(dateValue);
    const today = new Date();

    // Check if date is valid
    if (isNaN(date.getTime())) {
      errors.update(errs => ({ ...errs, date: '📅 Please enter a valid date' }));
      return false;
    }

    // Check if date is not too far in the future (more than 1 year)
    const oneYearFromNow = new Date();
    oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);

    if (date > oneYearFromNow) {
      errors.update(errs => ({ ...errs, date: '📅 Date cannot be more than 1 year in the future' }));
      return false;
    }

    errors.update(errs => ({ ...errs, date: '' }));
    return true;
  }

  let validationTimeout: ReturnType<typeof setTimeout> | undefined;
  function debounceSmartValidation() {
    if (validationTimeout) clearTimeout(validationTimeout);
    validationTimeout = setTimeout(() => {
      checkSmartValidation();
    }, 200);
  }

  async function checkSmartValidation() {
    try {
      const data = $formData;
      if (!data) {
        smartWarning.set({ show: false, type: '', data: {} });
        return;
      }

      const amount = parseCurrencyInput(data.amount);
      const category = data.category;

      if (amount <= 0 || !category || category === 'UNCATEGORIZED') {
        smartWarning.set({ show: false, type: '', data: {} });
        return;
      }

      // Use $budgetStore directly - single source of truth
      const currentBudget = $budgetStore;

      if (currentBudget && typeof currentBudget === 'object' && currentBudget.categories && currentBudget.categories[category.toLowerCase()]) {
        evaluateBudgetWarning(amount, category, currentBudget.categories[category.toLowerCase()]);
      } else {
        smartWarning.set({ show: false, type: '', data: {} });
      }
    } catch (error) {
      console.error('Error in checkSmartValidation:', error);
      smartWarning.set({ show: false, type: '', data: {} });
    }
  }

  function evaluateBudgetWarning(amount: number, category: string, categoryData: any) {
    // Safety check
    if (!categoryData) {
      smartWarning.set({ show: false, type: '', data: {} });
      return;
    }

    const currentSpent = categoryData.spent || 0;
    const budget = categoryData.budget || 0;
    const newTotal = currentSpent + amount;
    const percentage = budget > 0 ? (newTotal / budget) * 100 : 0;

    // Check if we should show warning (first time per day per category+threshold)
    const warningKey = `${category.toLowerCase()}_${Math.floor(percentage / 10) * 10}`;
    const today = new Date().toDateString();
    const lastWarning = dailyWarnings.get(warningKey);

    if (lastWarning === today) return;

    let shouldWarn = false;
    let warningType = '';
    let warningData = {};

    if (percentage >= 100) {
      shouldWarn = true;
      warningType = 'exceeded';
      warningData = {
        category: formatCategoryName(category),
        overage: formatCurrency(newTotal - budget),
        newTotal: formatCurrency(newTotal),
        budget: formatCurrency(budget),
        percentage: Math.round(percentage)
      };
    } else if (percentage >= 80) {
      shouldWarn = true;
      warningType = 'caution';
      warningData = {
        category: formatCategoryName(category),
        percentage: Math.round(percentage),
        remaining: formatCurrency(budget - newTotal)
      };
    }

    if (shouldWarn) {
      smartWarning.set({
        show: true,
        type: warningType,
        data: warningData
      });
      dailyWarnings.set(warningKey, today);
    } else {
      smartWarning.set({ show: false, type: '', data: {} });
    }
  }

  async function handleSubmit(event: Event) {
    event.preventDefault();

    if (!$isFormValid || isSubmitting) return;

    try {
      isSubmitting = true;
      errors.update(errs => ({ ...errs, system: '' }));

      const data = $formData;
      const amount = parseCurrencyInput(data.amount);

      // Validate form data
      if (!validateFormData(amount, data)) {
        return;
      }

      // Get current user
      const user = await authService.getCurrentUser();
      if (!user) {
        errors.update(errs => ({ ...errs, system: 'Please sign in to save expenses' }));
        return;
      }

      // Get current period ID
      const currentPeriodId = await periodService.getCurrentPeriodId();

      // 🔥 FIREBASE: Create expense in Firestore
      // Empty category defaults to UNCATEGORIZED
      const finalCategory = data.category === '' || !data.category ? 'UNCATEGORIZED' : data.category.toUpperCase();

      const expenseData = {
        amount,
        category: finalCategory,
        description: data.description,
        date: new Date(data.date),
        periodId: currentPeriodId
      };

      const expenseId = await expenseService.addExpense(expenseData);

      // 🔥 FIREBASE: Sync budget spending
      await periodService.syncBudgetWithExpenses(currentPeriodId);

      // Update local stores for immediate UI update
      await expenseActions.addExpense({
        ...expenseData,
        id: expenseId,
        userId: user.uid
      } as any);

      console.log('✅ Expense saved to Firebase:', expenseId);

      // Show success and redirect
      showSuccessState = true;
      setTimeout(() => {
        handleReturn();
      }, 1500);

    } catch (error) {
      console.error('Error saving expense:', error);
      handleSubmissionError(error);
    } finally {
      isSubmitting = false;
    }
  }

  function validateFormData(amount: number, data: any): boolean {
    let hasErrors = false;

    // Validate amount using consolidated logic
    if (!amount || amount < MIN_AMOUNT) {
      errors.update(errs => ({ ...errs, amount: "Don't leave me empty! I need an amount!" }));
      hasErrors = true;
    } else if (!isValidAmount(amount)) {
      errors.update(errs => ({ ...errs, amount: `Whoa there, millionaire! Max Rp ${formatCurrencyInput(MAX_AMOUNT)} please!` }));
      hasErrors = true;
    }

    if (!data.date) {
      errors.update(errs => ({ ...errs, date: "Don't leave me empty! I need a date!" }));
      hasErrors = true;
    } else if (!validateDateInput(data.date)) {
      hasErrors = true;
    }

    return !hasErrors;
  }

  function handleSubmissionError(error: any) {
    if (error.code === 'permission-denied') {
      errors.update(errs => ({ ...errs, system: 'Unable to save expense. Please try signing in again' }));
    } else if (error.message?.includes('network')) {
      errors.update(errs => ({ ...errs, system: 'Something went wrong saving your expense: Network error' }));
    } else {
      errors.update(errs => ({ ...errs, system: 'Oops! Something went wrong. Please try again!' }));
    }
  }

  function handleReturn() {
    // Smart return logic based on returnPath
    switch (returnPath) {
      case 'budget':
        goto('/budget');
        break;
      case 'expenses':
        goto('/expenses');
        break;
      case 'dashboard':
      default:
        goto('/dashboard');
        break;
    }
  }

  function formatCategoryName(category: string): string {
    const names: Record<string, string> = {
      'FOOD': 'Makanan',
      'food': 'Makanan',
      'TRANSPORT': 'Transport',
      'transport': 'Transport',
      'SHOPPING': 'Belanja',
      'shopping': 'Belanja',
      'ENTERTAINMENT': 'Hiburan',
      'entertainment': 'Hiburan',
      'HEALTH': 'Kesehatan',
      'health': 'Kesehatan',
      'EDUCATION': 'Pendidikan',
      'education': 'Pendidikan',
      'UTILITIES': 'Tagihan',
      'utilities': 'Tagihan',
      'OTHER': 'Lainnya',
      'other': 'Lainnya'
    };
    return names[category] || category;
  }

  function formatCurrency(amount: number): string {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

  function getCurrentPeriodId(): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
  }

  function generateTempId(): string {
    return `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
</script>

<div class="add-expense-page">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Add Expense</h1>
      <button class="close-button" on:click={handleReturn} aria-label="Close">
        ✕
      </button>
    </div>
  </div>

  <div class="expense-container">
    {#if !showSuccessState}
      <!-- Smart Warning -->
      {#if $smartWarning.show}
        <SmartWarning type={$smartWarning.type} data={$smartWarning.data} />
      {/if}

      <!-- Form -->
      <form class="expense-form glass-card" on:submit={handleSubmit}>
        <!-- Input Method Selection -->
        <div class="input-method-section">
          <button type="button" class="method-tab active">
            <div class="method-icon">✏️</div>
            <div class="method-label">Manual Input</div>
          </button>
          <button type="button" class="method-tab disabled" disabled>
            <div class="method-icon">📷</div>
            <div class="method-label">Invoice OCR</div>
            <span class="coming-soon-badge">Soon</span>
          </button>
        </div>

        <!-- Amount Input -->
        <div class="form-group">
          <label for="expenseAmount" class="form-label">Amount *</label>
          <div class="currency-input-group">
            <span class="currency-prefix">Rp</span>
            <input
              type="text"
              id="expenseAmount"
              class="glass-input currency-input"
              class:error-state={$errors.amount}
              placeholder="0"
              value={$formData.amount}
              on:input={handleAmountInput}
              required
            />
          </div>
          {#if $errors.amount}
            <div class="field-error">{$errors.amount}</div>
          {/if}
        </div>

        <!-- Category Selection with Tiles -->
        <div class="form-group">
          <div id="category-label" class="form-label">Category (Optional)</div>
          <CategoryTileSelector
            aria-labelledby="category-label"
            selectedCategory={$formData.category}
            {categories}
            isLoading={isLoadingCategories}
            showBudgetInfo={true}
            on:categoryChange={handleCategoryTileChange}
            on:setupBudget={handleSetupBudget}
          />
          {#if $errors.category}
            <div class="field-error">{$errors.category}</div>
          {/if}
        </div>

        <!-- Date Input -->
        <div class="form-group">
          <label for="expenseDate" class="form-label">Date *</label>
          {#key dateInputKey}
            <input
              type="date"
              id="expenseDate"
              class="glass-input date-input"
              class:error-state={$errors.date}
              bind:value={dateValue}
              on:change={handleDateChange}
              on:click={handleDateClick}
              on:focus={handleDateFocus}
              required
            />
          {/key}
          {#if $errors.date}
            <div class="field-error">{$errors.date}</div>
          {/if}
        </div>

        <!-- Description Input -->
        <div class="form-group">
          <label for="expenseDescription" class="form-label">Notes (Optional)</label>
          <textarea
            id="expenseDescription"
            class="glass-input glass-textarea"
            class:error-state={$errors.description}
            placeholder="What did you spend on?"
            value={$formData.description}
            on:input={handleDescriptionInput}
            rows="3"
          ></textarea>
          {#if $errors.description}
            <div class="field-error">{$errors.description}</div>
          {/if}
        </div>

        <!-- System Error -->
        {#if $errors.system}
          <div class="system-error-container">
            <div class="system-error field-error show">{$errors.system}</div>
          </div>
        {/if}

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn-primary btn-primary-full"
            disabled={!$isFormValid || isSubmitting}
          >
            {#if isSubmitting}
              <span class="loading-spinner"></span>
              Saving...
            {:else}
              Save Expense
            {/if}
          </button>
        </div>
      </form>
    {:else}
      <!-- Success State -->
      <div class="success-container glass-card">
        <div class="success-icon">✅</div>
        <h2>Expense Saved!</h2>
        <p>Your expense has been recorded successfully</p>
        <div class="expense-summary">
          <div class="amount">{formatCurrency(parseCurrencyInput($formData.amount))}</div>
          <div class="category">{formatCategoryName($formData.category)}</div>
        </div>
      </div>
    {/if}
  </div>

  <!-- Footer -->
  <footer class="add-expense-footer">
    <div class="footer-content">
      <p class="footer-text">
        📧 <a href="mailto:tegarerputra@outlook.com" class="footer-email-link">tegarerputra@outlook.com</a>
        <span class="footer-separator">•</span>
        © {new Date().getFullYear()} DuitTrack
      </p>
    </div>
  </footer>
</div>

<style>
  .add-expense-page {
    min-height: 100vh;
    position: relative;
    padding: 0;
    /* White background with subtle cyan accents - matching dashboard */
    background:
      radial-gradient(circle at 30% 20%, rgba(0, 191, 255, 0.06) 0%, transparent 40%),
      radial-gradient(circle at 70% 80%, rgba(30, 144, 255, 0.05) 0%, transparent 40%),
      radial-gradient(circle at 50% 50%, rgba(0, 123, 255, 0.03) 0%, transparent 30%),
      linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
    overflow: hidden;
  }

  .add-expense-page::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
      radial-gradient(circle at 20% 30%, rgba(0, 191, 255, 0.05) 0%, transparent 25%),
      radial-gradient(circle at 80% 70%, rgba(30, 144, 255, 0.04) 0%, transparent 25%),
      radial-gradient(circle at 50% 10%, rgba(0, 123, 255, 0.03) 0%, transparent 20%);
    animation: float-accent 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  .add-expense-page::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    height: 500px;
    background: radial-gradient(circle,
      rgba(0, 191, 255, 0.08) 0%,
      rgba(30, 144, 255, 0.06) 25%,
      rgba(6, 182, 212, 0.04) 50%,
      transparent 70%);
    border-radius: 50%;
    filter: blur(80px);
    animation: pulse-glow 10s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  .page-header {
    padding: 20px 0;
    background: transparent;
    position: relative;
    z-index: 2;
    margin-bottom: 20px;
  }

  .header-content {
    max-width: 500px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .page-title {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    letter-spacing: -0.01em;
  }

  .close-button {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1.5px solid rgba(203, 213, 225, 0.8);
    color: #6b7280;
    font-size: 1.5rem;
    font-weight: 300;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    line-height: 1;
    box-shadow:
      0 1px 3px rgba(0, 0, 0, 0.05),
      inset 0 1px 2px rgba(255, 255, 255, 0.8);
  }

  .close-button:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    color: var(--danger-red);
    transform: rotate(90deg);
  }

  .close-button:active {
    transform: rotate(90deg) scale(0.95);
  }

  .expense-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 0 1rem 2.5rem;
  }

  .glass-card {
    /* Secondary glassmorphism styling */
    background: linear-gradient(135deg,
      rgba(255, 255, 255, 0.5) 0%,
      rgba(240, 248, 255, 0.4) 50%,
      rgba(248, 252, 255, 0.6) 100%);
    backdrop-filter: blur(25px) saturate(1.8);
    -webkit-backdrop-filter: blur(25px) saturate(1.8);
    border: 1px solid rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    box-shadow:
      0 8px 32px rgba(0, 191, 255, 0.03),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    z-index: 1;
  }

  .expense-form {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .input-method-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .method-tab {
    position: relative;
    padding: 0.875rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    font-weight: 500;
    color: #6b7280;
  }

  .method-tab.active {
    border-color: #00BFFF;
    background: rgba(0, 191, 255, 0.1);
    color: #00BFFF;
    box-shadow: 0 2px 8px rgba(0, 191, 255, 0.15);
  }

  .method-tab.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .method-icon {
    font-size: 1.75rem;
    line-height: 1;
  }

  .method-label {
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
    line-height: 1.2;
  }

  .coming-soon-badge {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    background: rgba(251, 191, 36, 0.9);
    color: white;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .form-label {
    font-weight: 600;
    color: #4a5568;
    font-size: 0.875rem;
  }

  .glass-input {
    padding: 0.75rem 1rem;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1.5px solid rgba(203, 213, 225, 0.8);
    color: #1f2937;
    font-size: 0.9375rem;
    transition: all 0.3s ease;
    width: 100%;
    box-shadow:
      0 1px 3px rgba(0, 0, 0, 0.05),
      inset 0 1px 2px rgba(255, 255, 255, 0.8);
  }

  .glass-textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
    line-height: 1.5;
  }

  .glass-input::placeholder {
    color: #9ca3af;
  }

  .glass-input:focus {
    outline: none;
    border-color: #00BFFF;
    background: rgba(255, 255, 255, 0.75);
    box-shadow:
      0 0 0 3px rgba(0, 191, 255, 0.15),
      0 2px 8px rgba(0, 191, 255, 0.1),
      inset 0 1px 2px rgba(255, 255, 255, 0.9);
  }

  .glass-input.error-state {
    border-color: var(--danger-red);
    background: rgba(239, 68, 68, 0.05);
  }

  .currency-input-group {
    position: relative;
    display: flex;
    align-items: center;
  }

  .currency-prefix {
    position: absolute;
    left: 1rem;
    color: #6b7280;
    font-weight: 500;
    z-index: 1;
    pointer-events: none;
  }

  .currency-input {
    padding-left: 2.75rem;
    text-align: right;
    font-weight: 600;
    color: #0f172a;
  }


  .date-input {
    font-family: inherit;
    color: #1f2937;
  }

  .date-input::-webkit-calendar-picker-indicator {
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .date-input::-webkit-calendar-picker-indicator:hover {
    opacity: 1;
  }

  .field-error {
    color: var(--danger-red);
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.25rem;
    animation: shake 0.5s ease;
  }

  .system-error-container {
    margin: 0.5rem 0;
  }

  .system-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--danger-red);
    font-weight: 500;
    text-align: center;
  }

  .form-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .btn-primary-full {
    width: 100%;
  }

  .btn-primary {
    padding: 0.875rem 1.25rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    border: none;
    /* Vibrant cyan gradient matching FintechButton */
    background: linear-gradient(135deg,
      #00BFFF 0%,
      #1E90FF 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    box-shadow: 0 4px 16px rgba(0, 191, 255, 0.25);
    position: relative;
    overflow: hidden;
  }

  .btn-primary:hover:not(:disabled) {
    background: linear-gradient(135deg,
      #00A8E8 0%,
      #1873CC 100%);
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 8px 24px rgba(0, 191, 255, 0.35);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .btn-primary:active:not(:disabled) {
    transform: translateY(-1px) scale(1.01);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 4px 16px rgba(0, 191, 255, 0.15);
  }

  .loading-spinner {
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .success-container {
    padding: 2rem;
    text-align: center;
  }

  .success-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .success-container h2 {
    color: #1f2937;
    margin-bottom: 0.5rem;
  }

  .success-container p {
    color: #6b7280;
    margin-bottom: 1.5rem;
  }

  .expense-summary {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    padding: 1rem;
  }

  .expense-summary .amount {
    font-size: 1.5rem;
    font-weight: 600;
    color: #10b981;
    margin-bottom: 0.25rem;
  }

  .expense-summary .category {
    color: #6b7280;
    font-size: 0.9rem;
  }

  /* Animations */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes float-accent {
    0%, 100% {
      transform: translateY(0px) rotate(0deg);
      opacity: 1;
    }
    33% {
      transform: translateY(-15px) rotate(120deg);
      opacity: 0.8;
    }
    66% {
      transform: translateY(10px) rotate(240deg);
      opacity: 0.9;
    }
  }

  @keyframes pulse-glow {
    0%, 100% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 0.6;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.1);
      opacity: 0.8;
    }
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    /* Enhanced mobile background accents - matching dashboard */
    .add-expense-page {
      background:
        radial-gradient(circle at 30% 20%, rgba(0, 191, 255, 0.08) 0%, transparent 40%),
        radial-gradient(circle at 70% 80%, rgba(30, 144, 255, 0.06) 0%, transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(0, 123, 255, 0.04) 0%, transparent 30%),
        linear-gradient(135deg, #ffffff 0%, #f8faff 100%);
    }

    .add-expense-page::before {
      background-image:
        radial-gradient(circle at 20% 30%, rgba(0, 191, 255, 0.06) 0%, transparent 25%),
        radial-gradient(circle at 80% 70%, rgba(30, 144, 255, 0.05) 0%, transparent 25%),
        radial-gradient(circle at 50% 10%, rgba(0, 123, 255, 0.04) 0%, transparent 20%);
    }

    .page-header {
      padding: 1rem 0 0.5rem 0;
      margin-bottom: 0.75rem;
    }

    .header-content {
      padding: 0 1rem;
    }

    .page-title {
      font-size: 1.5rem;
    }

    .expense-container {
      padding: 0 1rem 2rem;
    }

    .expense-form {
      padding: 1rem;
      gap: 0.875rem;
    }

    .input-method-section {
      margin-bottom: 0.25rem;
    }

    .method-tab {
      padding: 0.75rem 0.5rem;
    }

    .method-icon {
      font-size: 1.5rem;
    }

    .method-label {
      font-size: 0.75rem;
    }

    .form-group {
      gap: 0.375rem;
    }

    .form-label {
      font-size: 0.8125rem;
    }

    .glass-input {
      padding: 0.75rem 0.875rem;
      font-size: 0.9375rem;
    }

    .form-actions {
      flex-direction: column;
      gap: 0.625rem;
      margin-top: 0.5rem;
    }

    .btn-primary {
      padding: 0.875rem;
      font-size: 0.9375rem;
    }
  }

  @media (max-width: 430px) {
    /* Extra enhancement for small screens - matching dashboard */
    .add-expense-page {
      background:
        radial-gradient(circle at 25% 25%, rgba(0, 191, 255, 0.1) 0%, transparent 35%),
        radial-gradient(circle at 75% 75%, rgba(30, 144, 255, 0.08) 0%, transparent 35%),
        linear-gradient(135deg, #ffffff 0%, #f6f9ff 100%);
    }

    .add-expense-page::before {
      background-image:
        radial-gradient(circle at 15% 40%, rgba(0, 191, 255, 0.08) 0%, transparent 20%),
        radial-gradient(circle at 85% 60%, rgba(30, 144, 255, 0.06) 0%, transparent 20%);
    }
  }

  /* Add Expense Footer */
  .add-expense-footer {
    margin-top: 40px;
    padding: 24px 20px;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(6, 182, 212, 0.1);
    border-radius: 16px 16px 0 0;
    position: relative;
    z-index: 2;
  }

  .add-expense-footer .footer-content {
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
  }

  .add-expense-footer .footer-text {
    font-size: 14px;
    font-weight: 500;
    color: #6b7280;
    margin: 0;
    line-height: 1.6;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .add-expense-footer .footer-email-link {
    color: #0891B2;
    text-decoration: none;
    transition: all 0.2s ease;
    font-weight: 600;
  }

  .add-expense-footer .footer-email-link:hover {
    color: #06B6D4;
    text-decoration: underline;
  }

  .add-expense-footer .footer-separator {
    color: #d1d5db;
    font-weight: 400;
    padding: 0 4px;
  }

  /* Mobile responsive footer */
  @media (max-width: 430px) {
    .add-expense-footer {
      margin-top: 32px;
      padding: 20px 16px;
    }

    .add-expense-footer .footer-text {
      font-size: 13px;
      gap: 6px;
    }

    .add-expense-footer .footer-email-link {
      font-size: 13px;
    }
  }
</style>